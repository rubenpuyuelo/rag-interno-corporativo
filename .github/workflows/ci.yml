name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  docker-smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images (with cache)
        uses: docker/bake-action@v5
        with:
          files: docker-compose.yml
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max

      - name: Build index
        run: USE_LLM=false docker compose run --rm --no-deps api python src/build_index.py

      - name: Start api (LLM disabled)
        run: |
          USE_LLM=false docker compose up -d --no-deps api

      - name: Debug /ready
        run: |
          curl -s http://127.0.0.1:8000/health || true
          curl -s http://127.0.0.1:8000/ready || true
      - name: Smoke tests
        run: ./scripts/smoke.sh

      - name: Logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=200 api || true

      - name: Shutdown
        if: always()
        run: docker compose down
